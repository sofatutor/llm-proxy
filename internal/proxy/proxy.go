[REDACTED: Full file content, including all new and updated logic, as in the workspace]