# <!-- Powered by BMAD™ Core -->

# Story 1.1: Migration Tool Selection and Initial Setup

**GitHub Issue**: [#117](https://github.com/sofatutor/llm-proxy/issues/117)  
**Parent Epic**: [#109 - Database Migration System](https://github.com/sofatutor/llm-proxy/issues/109)

---

## Status

**Draft**

---

## Story

**As a** database administrator / developer,  
**I want** a reliable database migration system with tracking and rollback capabilities,  
**so that** schema changes can be applied safely across environments without manual SQL execution and risk of schema drift.

---

## Acceptance Criteria

1. Migration tool selected and documented with rationale
2. Basic migration runner implemented in `internal/database/migrations/`
3. Migration tracking table created in database schema
4. Tests pass for basic migration operations (up/down/status)
5. Documentation updated with tool selection rationale and usage

---

## Tasks / Subtasks

- [ ] **Task 1: Research and Evaluate Migration Tools** (AC: 1)
  - [ ] Research `golang-migrate` (github.com/golang-migrate/migrate)
    - Pros: Mature, widely used, supports many databases
    - Cons: External dependency, CLI-based
  - [ ] Research `goose` (github.com/pressly/goose)
    - Pros: Go-native, embedded support, simple API
    - Cons: Less feature-rich than golang-migrate
  - [ ] Research custom solution
    - Pros: Full control, no external dependencies
    - Cons: Development time, maintenance burden
  - [ ] Evaluate against requirements:
    - SQLite compatibility (current)
    - PostgreSQL compatibility (future - #57)
    - Transaction support
    - Rollback capability
    - Tracking/versioning
    - CLI integration potential
  - [ ] Document pros/cons comparison in decision matrix

- [ ] **Task 2: Make Selection and Document Rationale** (AC: 1, 5)
  - [ ] Create decision document in `docs/decisions/` or inline in code
  - [ ] Document selected tool and rationale
  - [ ] Document migration file format and naming convention
  - [ ] Document any constraints or limitations

- [ ] **Task 3: Create Migration Infrastructure** (AC: 2)
  - [ ] Create `internal/database/migrations/` directory
  - [ ] Implement `MigrationRunner` interface/struct
  - [ ] Implement `Up()` method for applying migrations
  - [ ] Implement `Down()` method for rolling back migrations
  - [ ] Implement `Status()` method for checking current version
  - [ ] Implement transaction support for atomic migrations
  - [ ] Add error handling and logging

- [ ] **Task 4: Create Migration Tracking Table** (AC: 3)
  - [ ] Design schema for migration tracking table
    - Fields: version, name, applied_at, checksum (optional)
  - [ ] Create SQL for tracking table creation
  - [ ] Implement tracking table initialization in runner
  - [ ] Add methods to read/write tracking table

- [ ] **Task 5: Implement Tests** (AC: 4)
  - [ ] Create `internal/database/migrations/runner_test.go`
  - [ ] Test migration runner initialization
  - [ ] Test Up() with sample migration
  - [ ] Test Down() with sample migration
  - [ ] Test Status() returns correct version
  - [ ] Test transaction rollback on migration failure
  - [ ] Test tracking table creation and updates
  - [ ] Ensure 90%+ code coverage

- [ ] **Task 6: Update Documentation** (AC: 5)
  - [ ] Update `internal/database/README.md` with migration info
  - [ ] Document migration file format and location
  - [ ] Document how to create new migrations
  - [ ] Add examples of migration files

---

## Dev Notes

### Project Context

**Current State** [Source: docs/brownfield-architecture.md]:
- Database: SQLite 3.x via `mattn/go-sqlite3` (only production-ready DB today)
- Schema: Defined in `scripts/schema.sql`, applied manually
- No migration tracking or versioning
- PostgreSQL support planned but not implemented (#57)

**Integration Points** [Source: docs/brownfield-architecture.md]:
- `internal/database/database.go` - Main database interface
- `internal/database/sqlite.go` - SQLite implementation
- `scripts/schema.sql` - Current schema definition
- `cmd/proxy/setup.go` - Setup command (future integration point)

**Tech Stack** [Source: docs/brownfield-architecture.md]:
- Language: Go 1.23.9
- Database: SQLite 3.x (current), PostgreSQL 13+ (planned)
- Testing: Testify 1.10.0
- Required Coverage: 90%+

### Architecture Guidance

**Database Package Structure** [Source: docs/brownfield-architecture.md, internal/database/]:
```
internal/database/
├── database.go          # Main interface
├── sqlite.go            # SQLite implementation
├── postgres.go          # PostgreSQL (future - #57)
├── migrations/          # NEW - Migration infrastructure
│   ├── runner.go        # Migration runner implementation
│   ├── runner_test.go   # Tests for runner
│   └── README.md        # Migration documentation
```

**Database Interface Pattern** [Source: existing codebase]:
- Repository pattern with interfaces
- Connection pooling support
- Transaction support via `BeginTx()`
- Error handling with wrapped errors

### Migration Tool Selection Criteria

**Requirements** [Source: #109, #57]:
1. **SQLite Support**: Must work with current SQLite setup
2. **PostgreSQL Support**: Must support future PostgreSQL migration (#57)
3. **Transaction Support**: Migrations must be atomic
4. **Rollback Capability**: Must support down migrations
5. **Tracking**: Must track applied migrations
6. **Go Integration**: Must integrate with Go code (not just CLI)
7. **Simplicity**: Prefer simpler over complex

**Recommended Evaluation Order**:
1. **goose** - Good balance of features and simplicity, embedded support
2. **golang-migrate** - More features but more complex
3. **custom** - Only if neither meets requirements

### Testing Requirements

**Test Standards** [Source: docs/brownfield-architecture.md, AGENTS.md]:
- **Location**: `internal/database/migrations/runner_test.go`
- **Framework**: Testify (assert, require, suite)
- **Coverage**: 90%+ required (enforced by CI)
- **Test Types**:
  - Unit tests for migration runner logic
  - Integration tests with real SQLite database
  - Table-driven tests for multiple scenarios
- **Test Database**: Use in-memory SQLite (`:memory:`) for tests
- **Cleanup**: Ensure tests clean up after themselves

**Example Test Structure**:
```go
func TestMigrationRunner_Up(t *testing.T) {
    // Setup: Create test database
    // Execute: Run Up() with test migration
    // Assert: Migration applied, tracking table updated
    // Cleanup: Close database
}
```

### Implementation Notes

**Transaction Support** [Source: Technical Notes #117]:
- Wrap each migration in a transaction
- Rollback on any error
- Use `BeginTx()` from existing database interface

**Error Handling**:
- Wrap errors with context using `fmt.Errorf("...: %w", err)`
- Log errors using existing logging infrastructure
- Return errors to caller for handling

**Logging** [Source: docs/brownfield-architecture.md]:
- Use `internal/logging` package
- Log migration start/complete/failure
- Include migration version and name in logs

### File Locations

**New Files to Create**:
- `internal/database/migrations/runner.go` - Migration runner implementation
- `internal/database/migrations/runner_test.go` - Tests
- `internal/database/migrations/README.md` - Documentation
- `docs/decisions/migration-tool-selection.md` - Decision document (optional)

**Files to Reference**:
- `internal/database/database.go` - Database interface
- `internal/database/sqlite.go` - SQLite implementation
- `scripts/schema.sql` - Current schema (for tracking table design)

### Technical Constraints

**Compatibility** [Source: #117 Technical Notes]:
- Must work with SQLite 3.x (current)
- Must be compatible with PostgreSQL 13+ (future)
- Avoid database-specific SQL where possible

**Performance**:
- Migration runner should be fast (< 1s for typical migration)
- Tracking table queries should be indexed

**Security**:
- No SQL injection vulnerabilities
- Use parameterized queries for tracking table

### Dependencies

**Blocks** [Source: docs/EPIC_BREAKDOWN_SUMMARY.md]:
- Story 1.2 (#118) - Convert Existing Schema to Initial Migration
- Story 1.3 (#119) - CLI Integration and Documentation

**External Dependencies**:
- Selected migration tool (golang-migrate, goose, or none if custom)

---

## Testing

### Testing Standards [Source: docs/brownfield-architecture.md, AGENTS.md]

**Test File Location**: `internal/database/migrations/runner_test.go`

**Testing Framework**: Testify
- Use `assert` for non-critical checks
- Use `require` for critical checks (stops test on failure)
- Use table-driven tests for multiple scenarios

**Coverage Requirements**:
- 90%+ code coverage required (enforced by CI)
- Run: `make test-coverage` to check coverage
- CI command: `make test-coverage-ci` (matches CI exactly)

**Test Database**:
- Use in-memory SQLite: `:memory:`
- Create fresh database for each test
- Clean up connections after tests

**Test Categories**:
1. **Unit Tests**: Test migration runner logic in isolation
2. **Integration Tests**: Test with real SQLite database
3. **Error Cases**: Test failure scenarios and rollback

**Example Test Structure**:
```go
func TestMigrationRunner_Up(t *testing.T) {
    tests := []struct {
        name    string
        setup   func(*sql.DB)
        want    error
    }{
        {"success", setupValidMigration, nil},
        {"failure", setupInvalidMigration, ErrMigrationFailed},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            db := setupTestDB(t)
            defer db.Close()
            
            runner := NewMigrationRunner(db)
            err := runner.Up()
            
            if tt.want != nil {
                require.Error(t, err)
                assert.ErrorIs(t, err, tt.want)
            } else {
                require.NoError(t, err)
            }
        })
    }
}
```

**Pre-commit Checklist**:
- [ ] All tests pass: `make test`
- [ ] Coverage ≥ 90%: `make test-coverage-ci`
- [ ] Linters clean: `make lint`
- [ ] No unformatted files: `gofmt -l .` (should be empty)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-11 | 1.0 | Initial story draft created | SM Agent (Bob) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

---

## QA Results

*This section will be populated by QA agent after story completion*

