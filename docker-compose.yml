x-llm-proxy-base: &llm-proxy-base
  image: llm-proxy:latest
  restart: unless-stopped
  entrypoint: ["/app/entrypoint.sh"]
  read_only: true
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  tmpfs:
    - /tmp
  environment: &llm-proxy-env
    OPENAI_API_KEY: ${OPENAI_API_KEY}
    MANAGEMENT_TOKEN: ${MANAGEMENT_TOKEN}
    LOG_LEVEL: ${LOG_LEVEL:-info}
    ENABLE_METRICS: "true"
    PORT: ${PORT:-8080}
    LLM_PROXY_EVENT_BUS: redis-streams
    REDIS_ADDR: redis:6379
    REDIS_STREAM_KEY: llm-proxy-events
    REDIS_CONSUMER_GROUP: llm-proxy-dispatchers
    DB_DRIVER: postgres
    DATABASE_URL: postgres://llmproxy:${POSTGRES_PASSWORD:-secret}@postgres:5432/llmproxy?sslmode=disable
    HTTP_CACHE_ENABLED: ${HTTP_CACHE_ENABLED:-false}
    HTTP_CACHE_BACKEND: ${HTTP_CACHE_BACKEND:-in-memory}
    HTTP_CACHE_DEFAULT_TTL: ${HTTP_CACHE_DEFAULT_TTL:-300}
    CACHE_STATS_BUFFER_SIZE: ${CACHE_STATS_BUFFER_SIZE:-1000}
  volumes:
    - ./tmp/llm-proxy-data:/app/data
    - ./tmp/llm-proxy-logs:/app/logs
    - ./tmp/llm-proxy-config:/app/config
    - .env:/app/.env
    - ./config/api_providers.yaml:/app/config/api_providers.yaml

services:
  # PostgreSQL database service
  postgres:
    image: postgres:15
    container_name: llm-proxy-postgres
    environment:
      POSTGRES_USER: llmproxy
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secret}
      POSTGRES_DB: llmproxy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U llmproxy -d llmproxy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"  # Development only - remove or restrict for production
    restart: unless-stopped

  postgres-test:
    image: postgres:15
    container_name: llm-proxy-postgres-test
    profiles: ["postgres-test"]
    environment:
      POSTGRES_USER: llmproxy
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secret}
      POSTGRES_DB: llmproxy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U llmproxy -d llmproxy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    ports:
      - "55432:5432"  # Test-only Postgres; avoid clashing with dev instance
    restart: unless-stopped

  # MySQL database service
  mysql:
    image: mysql:8.4.5
    container_name: llm-proxy-mysql-db
    profiles: ["mysql"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-secret}
      MYSQL_DATABASE: llmproxy
      MYSQL_USER: llmproxy
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-secret}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"  # Development only - remove or restrict for production
    restart: unless-stopped

  mysql-test:
    image: mysql:8.4.5
    container_name: llm-proxy-mysql-test
    profiles: ["mysql-test"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-secret}
      MYSQL_DATABASE: llmproxy
      MYSQL_USER: llmproxy
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-secret}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - mysql_test_data:/var/lib/mysql
    ports:
      - "33306:3306"  # Test-only MySQL; avoid clashing with dev instance
    restart: unless-stopped

  # LLM Proxy service (uses PostgreSQL)
  llm-proxy:
    <<: *llm-proxy-base
    container_name: llm-proxy
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    command: ["server"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # LLM Proxy service (uses MySQL)
  llm-proxy-mysql:
    <<: *llm-proxy-base
    container_name: llm-proxy-mysql
    profiles: ["mysql"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        POSTGRES_SUPPORT: "false"
        MYSQL_SUPPORT: "true"
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    environment:
      <<: *llm-proxy-env
      DB_DRIVER: mysql
      DATABASE_URL: llmproxy:${MYSQL_PASSWORD:-secret}@tcp(mysql:3306)/llmproxy?parseTime=true
    command: ["server"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started

  logger:
    <<: *llm-proxy-base
    container_name: llm-proxy-file-logger
    environment:
      <<: *llm-proxy-env
      REDIS_CONSUMER_GROUP: llm-proxy-dispatchers-file
    command: ["dispatcher", "--service", "file", "--endpoint", "/app/logs/events.jsonl"]
    volumes:
      - ./tmp/llm-proxy-logs:/app/logs
    depends_on:
      - redis

  helicone:
    <<: *llm-proxy-base
    container_name: llm-proxy-helicone-logger
    environment:
      <<: *llm-proxy-env
      REDIS_CONSUMER_GROUP: llm-proxy-dispatchers-helicone
    command: ["dispatcher", "--service", "helicone", "--api-key", "${HELICONE_API_KEY}"]
    depends_on:
      - redis

  admin:
    <<: *llm-proxy-base
    container_name: llm-proxy-admin
    command: ["admin"]
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    environment:
      - ADMIN_UI_API_BASE_URL=http://llm-proxy:8080
    depends_on:
      - llm-proxy

  redis:
    image: redis:8
    container_name: llm-proxy-redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    command: ["redis-server", "--loglevel", "debug"]

volumes:
  postgres_data:
    name: llm-proxy-postgres-data
  postgres_test_data:
    name: llm-proxy-postgres-test-data
  mysql_data:
    name: llm-proxy-mysql-data
  mysql_test_data:
    name: llm-proxy-mysql-test-data
