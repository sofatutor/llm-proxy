apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "llm-proxy.fullname" . }}-test"
  labels:
    {{- include "llm-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:latest
      imagePullPolicy: IfNotPresent
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing LLM Proxy health endpoint..."
          
          # Wait for service to be available
          echo "Waiting for service to be ready..."
          for i in $(seq 1 30); do
            if curl -sf {{ include "llm-proxy.fullname" . }}:{{ .Values.service.port }}/health; then
              echo "Health check passed!"
              break
            fi
            echo "Attempt $i failed, retrying in 2s..."
            sleep 2
          done
          
          # Test health endpoint
          echo "Testing /health endpoint..."
          curl -f {{ include "llm-proxy.fullname" . }}:{{ .Values.service.port }}/health
          
          # Test readiness endpoint
          echo "Testing /ready endpoint..."
          curl -f {{ include "llm-proxy.fullname" . }}:{{ .Values.service.port }}/ready
          
          {{- if .Values.config.monitoring.enableMetrics }}
          # Test metrics endpoint
          echo "Testing /metrics endpoint..."
          curl -f {{ include "llm-proxy.fullname" . }}:{{ .Values.service.port }}/metrics
          {{- end }}
          
          echo "All tests passed!"
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 32Mi